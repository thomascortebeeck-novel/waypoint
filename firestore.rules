rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Check if user is an admin
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.is_admin == true;
    }
    
    // Helper to check if user is plan creator
    function isPlanCreator(planId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/plans/$(planId)).data.creator_id == request.auth.uid;
    }
    
    // Helper to check if user owns the plan (purchased)
    function ownsPlan(planId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)/purchasedPlans/$(planId));
    }
    
    // Helper to check if user has purchased the plan (via user document)
    function hasPurchasedPlan(planId) {
      return isSignedIn() &&
             planId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.purchased_plan_ids;
    }
    
    // Helper to check if user is trip member
    function isTripMember(tripId) {
      return isSignedIn() && 
             request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.member_ids;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can read their own data, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile
      allow create: if isSignedIn() && 
                      request.auth.uid == request.resource.data.id &&
                      // Prevent users from setting themselves as admin on creation
                      (!('is_admin' in request.resource.data) || request.resource.data.is_admin == false);
      
      // Users can update their own profile
      // Only admins can modify is_admin field
      allow update: if isOwner(userId) && 
                      // Non-admins cannot change is_admin field
                      (!('is_admin' in request.resource.data.diff(resource.data).affectedKeys()) || isAdmin());
      
      // Users can delete their own profile
      allow delete: if isOwner(userId);
      
      // Favorites subcollection - user can manage their own favorites
      match /favorites/{favoriteId} {
        allow read, write: if isOwner(userId);
      }
      
      // Purchased plans subcollection - user can read their purchases, system can create
      match /purchasedPlans/{purchasedPlanId} {
        allow read: if isOwner(userId);
        allow create: if isSignedIn();
      }
      
      // Following subcollection - user can read/write their own following list
      match /following/{creatorId} {
        allow read, write: if isOwner(userId);
      }
      
      // Followers subcollection - user can read their followers, system can write
      match /followers/{followerId} {
        allow read: if isOwner(userId);
        // Allow authenticated users to write (for follow/unfollow operations)
        allow write: if isSignedIn();
      }
      
      // Feed subcollection - user can read their own feed, system can write
      match /feed/{planId} {
        allow read: if isOwner(userId);
        // Allow authenticated creators to write to follower feeds (fan-out pattern)
        allow create: if isSignedIn();
        allow update, delete: if isSignedIn();
      }
      
      // Notifications subcollection - user can read/write their own notifications
      match /notifications/{notificationId} {
        allow read: if isOwner(userId);
        // Allow authenticated users to create notifications (for system notifications)
        allow create: if isSignedIn();
        // User can update their own notifications (mark as read)
        allow update: if isOwner(userId);
        // User can delete their own notifications
        allow delete: if isOwner(userId);
      }
    }
    
    // ============================================
    // PLANS COLLECTION (Marketplace)
    // ============================================
    match /plans/{planId} {
      // Anyone can read published plans
      // Creators can read their own unpublished plans
      // Admins can read all plans
      allow read: if resource.data.is_published == true ||
                    (isSignedIn() && request.auth.uid == resource.data.creator_id) ||
                    isAdmin();
      
      // Only signed-in users can create plans
      // Must set creator_id to their own UID
      allow create: if isSignedIn() && 
                      request.auth.uid == request.resource.data.creator_id;
      
      // Creator can update their own plans
      // Signed-in users can update favorite_count and sales_count
      // Admins can update any plan (for migrations, featuring, etc.)
      allow update: if isSignedIn() && (
                      request.auth.uid == resource.data.creator_id ||
                      (request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['favorite_count', 'sales_count'])) ||
                      isAdmin()
                    );
      
      // Only the creator or admin can delete plans
      allow delete: if isSignedIn() && 
                      (request.auth.uid == resource.data.creator_id || isAdmin());
      
      // ============================================
      // VERSIONS SUBCOLLECTION
      // ============================================
      match /versions/{versionId} {
        // Anyone can read versions of published plans
        // Plan creator can read their own versions
        // Users who purchased can read versions
        // Admins can read all
        allow read: if get(/databases/$(database)/documents/plans/$(planId)).data.is_published == true ||
                       isPlanCreator(planId) ||
                       hasPurchasedPlan(planId) ||
                       isAdmin();
        
        // Only plan creator or admin can write versions
        allow create, update, delete: if isPlanCreator(planId) || isAdmin();
        
        // ============================================
        // DAYS SUBCOLLECTION (within versions)
        // ============================================
        match /days/{dayId} {
          // Same read rules as versions
          allow read: if get(/databases/$(database)/documents/plans/$(planId)).data.is_published == true ||
                         isPlanCreator(planId) ||
                         hasPurchasedPlan(planId) ||
                         isAdmin();
          
          // Only plan creator or admin can write days
          allow create, update, delete: if isPlanCreator(planId) || isAdmin();
          
          // ============================================
          // WAYPOINTS SUBCOLLECTION (within days)
          // ============================================
          match /waypoints/{waypointId} {
            // Same read rules
            allow read: if get(/databases/$(database)/documents/plans/$(planId)).data.is_published == true ||
                           isPlanCreator(planId) ||
                           hasPurchasedPlan(planId) ||
                           isAdmin();
            
            // Only plan creator or admin can write waypoints
            allow create, update, delete: if isPlanCreator(planId) || isAdmin();
          }
        }
      }
      
      // ============================================
      // COMMENTS SUBCOLLECTION
      // ============================================
      match /comments/{commentId} {
        // Anyone can read comments for published plans
        // Plan creator can read comments for their own plans (even if unpublished)
        allow read: if get(/databases/$(database)/documents/plans/$(planId)).data.is_published == true ||
                       isPlanCreator(planId) ||
                       isAdmin();
        
        // Authenticated users can create comments
        allow create: if isSignedIn() &&
                       request.resource.data.user_id == request.auth.uid;
        
        // Only comment author can update their own comments
        // Only creator can respond to questions (update creator_response field)
        allow update: if isSignedIn() && (
                       request.auth.uid == resource.data.user_id ||
                       (isPlanCreator(planId) && 
                        'creator_response' in request.resource.data.diff(resource.data).affectedKeys()) ||
                       isAdmin()
                     );
        
        // Comment author or plan creator can delete comments
        allow delete: if isSignedIn() && (
                       request.auth.uid == resource.data.user_id ||
                       isPlanCreator(planId) ||
                       isAdmin()
                     );
      }
    }
    
    // ============================================
    // ORDERS COLLECTION
    // ============================================
    match /orders/{orderId} {
      // Users can read their own orders (as buyer)
      // Admins can read all orders
      allow read: if (isSignedIn() && request.auth.uid == resource.data.buyer_id) || isAdmin();
      
      // Signed-in users can create orders for themselves
      allow create: if isSignedIn() && 
                      request.auth.uid == request.resource.data.buyer_id;
      
      // Allow updating order status (for checkout flow)
      // Admins can update any order
      allow update: if (isSignedIn() && request.auth.uid == resource.data.buyer_id) || isAdmin();
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }
    
    // ============================================
    // TRIPS COLLECTION
    // ============================================
    match /trips/{tripId} {
      // Trip members can read their trips
      // Signed-in users can read trips with invites enabled (for invite code lookup)
      // Admins can read all trips
      allow read: if (isSignedIn() && request.auth.uid in resource.data.member_ids) || 
                    (isSignedIn() && resource.data.invite_enabled == true) ||
                    isAdmin();
      
      // Only signed-in users can create trips
      // Must be the owner
      allow create: if isSignedIn() && 
                      request.auth.uid == request.resource.data.owner_id;
      
      // Owner and members can update trip data
      // Users who purchased the plan can join trips with invites enabled (add themselves to member_ids)
      // Admins can update any trip
      allow update: if (isSignedIn() && request.auth.uid in resource.data.member_ids) || 
                      isAdmin() ||
                      // Allow joining via invite: user must have purchased the plan, 
                      // invites must be enabled, and user must be adding themselves to members
                      (isSignedIn() && 
                       resource.data.invite_enabled == true &&
                       hasPurchasedPlan(resource.data.plan_id) &&
                       request.auth.uid in request.resource.data.member_ids &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['member_ids', 'updated_at']));
      
      // Only the owner or admin can delete trips
      allow delete: if (isSignedIn() && request.auth.uid == resource.data.owner_id) || isAdmin();
      
      // ============================================
      // PACKING SUBCOLLECTION
      // ============================================
      match /packing/{categoryId} {
        // Trip members can read packing checklist
        allow read: if isTripMember(tripId) || isAdmin();
        
        // Trip members can create/update packing items
        allow create, update: if isTripMember(tripId) || isAdmin();
        
        // Only trip owner or admin can delete packing categories
        allow delete: if (isSignedIn() && 
                        get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                        isAdmin();
      }
      
      // ============================================
      // DAYS PROGRESS SUBCOLLECTION
      // ============================================
      match /days/{dayId} {
        // Trip members can read day progress
        allow read: if isTripMember(tripId) || isAdmin();
        
        // Trip members can create/update day progress
        allow create, update: if isTripMember(tripId) || isAdmin();
        
        // Only trip owner or admin can delete day progress
        allow delete: if (isSignedIn() && 
                        get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                        isAdmin();
      }
      
      // ============================================
      // GPS TRACKING SUBCOLLECTION
      // ============================================
      match /tracking/{recordId} {
        // Trip members can read tracking data
        allow read: if isTripMember(tripId) || isAdmin();
        
        // Trip members can create tracking records
        allow create: if isTripMember(tripId) || isAdmin();
        
        // No updates to tracking records (immutable)
        allow update: if false;
        
        // Only trip owner or admin can delete tracking records
        allow delete: if (isSignedIn() && 
                        get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                        isAdmin();
      }
      
      // ============================================
      // DAY SELECTIONS SUBCOLLECTION (Waypoint choices)
      // ============================================
      match /selections/{selectionId} {
        // Trip members can read selections
        allow read: if isTripMember(tripId) || isAdmin();
        
        // Trip members can create/update selections
        allow create, update: if isTripMember(tripId) || isAdmin();
        
        // Only trip owner or admin can delete selections
        allow delete: if (isSignedIn() && 
                        get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                        isAdmin();
      }
      
      // ============================================
      // MEMBER PACKING SUBCOLLECTION (Individual checklists)
      // ============================================
      match /member_packing/{memberId} {
        // Trip members can read member packing
        allow read: if isTripMember(tripId) || isAdmin();
        
        // Members can create/update their own packing checklist
        // Trip owner can manage all member packing
        allow create, update: if (isSignedIn() && request.auth.uid == memberId) ||
                                (isSignedIn() && get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                                isAdmin();
        
        // Only trip owner or admin can delete member packing
        allow delete: if (isSignedIn() && 
                        get(/databases/$(database)/documents/trips/$(tripId)).data.owner_id == request.auth.uid) ||
                        isAdmin();
      }
    }
  }
}
