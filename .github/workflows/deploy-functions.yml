name: Deploy Firebase Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab

jobs:
  deploy:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install function dependencies
      - name: Install Dependencies
        working-directory: ./functions
        run: npm install

      # 4. Build TypeScript to JavaScript
      - name: Build Functions
        working-directory: ./functions
        run: npm run build
      
      # 4.5. Verify build output
      - name: Verify Build Output
        working-directory: ./functions
        run: |
          echo "ðŸ“¦ Checking compiled functions..."
          ls -la lib/
          echo ""
          echo "ðŸ“ Contents of lib/index.js:"
          head -20 lib/index.js || echo "âš ï¸ index.js not found!"

      # 5. Install Firebase CLI globally
      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      # 6. Create service account credentials file
      - name: Setup Google Cloud Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-service-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json

      # 7. Create environment variables file (.env.yaml)
      - name: Create Environment Variables File
        working-directory: ./functions
        run: |
          cat > .env.yaml << 'EOF'
          GOOGLE_PLACES_KEY: "${{ secrets.GOOGLE_PLACES_API_KEY }}"
          MAPBOX_SECRET_TOKEN: "${{ secrets.MAPBOX_SECRET_TOKEN }}"
          EOF
          echo "âœ… Created .env.yaml with API keys (Google Places + Mapbox)"

      # 8. Deploy Cloud Functions
      - name: Deploy to Firebase
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          echo "ðŸš€ Starting deployment..."
          echo "ðŸ“‹ Project: ${{ secrets.FIREBASE_PROJECT_ID }}"
          echo ""
          firebase deploy --only functions \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --non-interactive \
            --force \
            --debug

      # 9. Cleanup sensitive files
      - name: Cleanup Credentials
        if: always()
        run: |
          rm -f $HOME/gcloud-service-key.json
          rm -f functions/.env.yaml

      # 10. Success notification
      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Cloud Functions deployed successfully!"
          echo "ðŸ“Š View logs: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/functions"
          echo "ðŸ” Functions deployed:"
          echo "  - placesSearch (Google Places)"
          echo "  - placeDetails (Google Places)"
          echo "  - geocodeAddress (Google Places)"
          echo "  - placePhoto (Google Places)"
          echo "  - getDirections (Mapbox)"
          echo "  - matchRoute (Mapbox)"
          echo "  - getElevationProfile (Mapbox)"
          echo "  - fetchMeta (Link previews)"

      # 11. Failure notification
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above for details."
          echo "Common issues:"
          echo "  1. Check Firebase Service Account JSON is valid"
          echo "  2. Verify API key is set correctly"
          echo "  3. Ensure functions/package.json has correct dependencies"
