name: Deploy Firebase Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab

jobs:
  deploy:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install function dependencies
      - name: Install Dependencies
        working-directory: ./functions
        run: npm install

      # 4. Build TypeScript to JavaScript
      - name: Build Functions
        working-directory: ./functions
        run: npm run build
      
      # 4.5. Verify build output
      - name: Verify Build Output
        working-directory: ./functions
        run: |
          echo "üì¶ Checking compiled functions..."
          ls -la lib/
          echo ""
          echo "üìù Contents of lib/index.js:"
          head -20 lib/index.js || echo "‚ö†Ô∏è index.js not found!"

      # 5. Install Firebase CLI globally
      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      # 6. Create service account credentials file
      - name: Setup Google Cloud Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-service-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json

      # 7. Set Google Places API key as Firebase secret
      - name: Set Firebase Secret
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          echo "${{ secrets.GOOGLE_PLACES_API_KEY }}" | firebase functions:secrets:set GOOGLE_PLACES_KEY \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --force \
            --data-file=-
        continue-on-error: true

      # 8. Deploy Cloud Functions
      - name: Deploy to Firebase
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          echo "üöÄ Starting deployment..."
          echo "üìã Project: ${{ secrets.FIREBASE_PROJECT_ID }}"
          echo ""
          firebase deploy --only functions \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --non-interactive \
            --force \
            --debug

      # 9. Cleanup sensitive files
      - name: Cleanup Credentials
        if: always()
        run: rm -f $HOME/gcloud-service-key.json

      # 10. Success notification
      - name: Deployment Summary
        if: success()
        run: |
          echo "‚úÖ Cloud Functions deployed successfully!"
          echo "üìä View logs: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/functions"
          echo "üîç Functions deployed:"
          echo "  - placesSearch (Google Places)"
          echo "  - placeDetails (Google Places)"
          echo "  - geocodeAddress (Google Places)"
          echo "  - placePhoto (Google Places)"
          echo "  - getDirections (Mapbox)"
          echo "  - matchRoute (Mapbox)"
          echo "  - getElevationProfile (Mapbox)"
          echo "  - fetchMeta (Link previews)"

      # 11. Failure notification
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
          echo "Common issues:"
          echo "  1. Check Firebase Service Account JSON is valid"
          echo "  2. Verify API key is set correctly"
          echo "  3. Ensure functions/package.json has correct dependencies"
