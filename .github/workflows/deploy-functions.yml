name: Deploy Firebase Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch: # Allows manual trigger from GitHub Actions tab

jobs:
  deploy:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout repository code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Install function dependencies
      - name: Install Dependencies
        working-directory: ./functions
        run: npm install

      # 4. Build TypeScript to JavaScript
      - name: Build Functions
        working-directory: ./functions
        run: npm run build
      
      # 4.5. Verify build output
      - name: Verify Build Output
        working-directory: ./functions
        run: |
          echo "ðŸ“¦ Checking compiled functions..."
          ls -la lib/
          echo ""
          echo "ðŸ“ Contents of lib/index.js:"
          head -20 lib/index.js || echo "âš ï¸ index.js not found!"

      # 5. Install Firebase CLI globally
      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      # 6. Install Google Cloud SDK and authenticate
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}
          export_default_credentials: true

      # 6.5. Create service account credentials file (for Firebase CLI compatibility)
      - name: Setup Google Cloud Credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-service-key.json
          chmod 600 $HOME/gcloud-service-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          echo "âœ… Service account credentials file created"
          
      # 6.6. Verify APIs are enabled (read-only check, should work even without enable permissions)
      - name: Verify Required APIs
        run: |
          echo "ðŸ”§ Verifying required APIs are enabled..."
          gcloud services list --enabled --project=${{ secrets.FIREBASE_PROJECT_ID }} --filter="name:cloudfunctions.googleapis.com OR name:cloudbuild.googleapis.com OR name:artifactregistry.googleapis.com" --format="table(name)" || echo "âš ï¸ Could not list services, but continuing..."
          echo "âœ… API verification complete (APIs should already be enabled)"

      # 7. Create .env file (NOT .env.yaml!) - Firebase expects KEY=value format
      - name: Create Environment Variables File
        working-directory: ./functions
        run: |
          echo "GOOGLE_PLACES_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }}" > .env
          echo "MAPBOX_SECRET_TOKEN=${{ secrets.MAPBOX_SECRET_TOKEN }}" >> .env
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> .env
          echo "âœ… Created .env file"
          echo "ðŸ“„ Verification:"
          ls -la .env
          echo "Lines in file: $(wc -l < .env)"
          echo "File contents (values redacted):"
          cat .env | sed 's/=.*/=***/'

      # 8. Verify .env exists
      - name: Verify Environment File
        working-directory: ./functions
        run: |
          if [ -f .env ]; then
            echo "âœ… .env found in functions/"
            echo "ðŸ“„ File size: $(wc -c < .env) bytes"
            echo "ðŸ“„ Line count: $(wc -l < .env)"
          else
            echo "âŒ ERROR: .env not found!"
            exit 1
          fi

      # 9. Deploy Cloud Functions
      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: $HOME/gcloud-service-key.json
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json
          echo "ðŸš€ Starting deployment..."
          echo "ðŸ“‹ Project: ${{ secrets.FIREBASE_PROJECT_ID }}"
          echo "ðŸ“‚ Checking .env file exists:"
          ls -la functions/.env && echo "âœ… .env file found" || echo "âŒ .env missing"
          echo ""
          echo "ðŸ” Verifying gcloud authentication..."
          gcloud config get-value project || echo "âš ï¸ Project not set, but continuing..."
          echo "âœ… Ready to deploy"
          echo ""
          # Deploy with explicit project to avoid API enablement checks
          firebase deploy --only functions \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --non-interactive \
            --force \
            --debug || (echo "âŒ Deployment failed. Check logs above." && exit 1)

      # 10. Cleanup sensitive files
      - name: Cleanup Credentials
        if: always()
        run: |
          rm -f $HOME/gcloud-service-key.json
          rm -f functions/.env
          rm -f functions/.env.yaml

      # 11. Success notification
      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Cloud Functions deployed successfully!"
          echo "ðŸ“Š View logs: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/functions"
          echo "ðŸ” Functions deployed:"
          echo "  - placesSearch (Google Places)"
          echo "  - placeDetails (Google Places)"
          echo "  - geocodeAddress (Google Places)"
          echo "  - placePhoto (Google Places)"
          echo "  - getDirections (Mapbox)"
          echo "  - matchRoute (Mapbox)"
          echo "  - getElevationProfile (Mapbox)"
          echo "  - fetchMeta (Link previews)"

      # 12. Failure notification
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above for details."
          echo ""
          echo "Common issues:"
          echo "  1. Check Firebase Service Account JSON is valid"
          echo "  2. Verify API keys (GOOGLE_PLACES_API_KEY, MAPBOX_SECRET_TOKEN) are set in GitHub Secrets"
          echo "  3. Ensure functions/package.json has correct dependencies"
          echo "  4. If you see '403' or 'permission' errors:"
          echo "     - The service account needs the 'Service Usage Consumer' role"
          echo "     - Grant it at: https://console.cloud.google.com/iam-admin/iam"
          echo "     - Role needed: roles/serviceusage.serviceUsageConsumer"
          echo "     - Or use: gcloud projects add-iam-policy-binding PROJECT_ID --member='serviceAccount:SERVICE_ACCOUNT_EMAIL' --role='roles/serviceusage.serviceUsageConsumer'"
